(()=>{"use strict";const t="home",e="product",r="category",o="cart",a="order",n="profile",i="cartUpdate",c="customer",s={[t]:"home",[e]:"product-view",[r]:"category-view",[o]:"cart",[a]:"order"};function l(t,e){return JSON.stringify(t)===JSON.stringify(e)}function m(t,e){if(t===e)return!0;if(typeof t!=typeof e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(!m(t[r],e[r]))return!1;return!0}if(t&&"object"==typeof t&&e&&"object"==typeof e){const r=Object.keys(t),o=Object.keys(e);if(r.length!==o.length)return!1;for(let o of r)if(!e.hasOwnProperty(o)||!m(t[o],e[o]))return!1;return!0}return t===e}function d(){const t=window.top.localStorage.getItem("crmback-cart")||null;return t?JSON.parse(t):null}function u(){const t=window._crmbackData||null;if(t?.pageType===a)throw new Error("Page type not allowed")}function h(t){return t?{key:"paymentSelected",value:t}:null}class p{constructor(){this.handlers={},this.data={}}init(){window._crmbackData=window._crmbackData||{pageType:null,pageData:null};try{this.time=(new Date).getTime(),this.page=String(location.href),this.watchLocation();const t=this.time,e=this.getPageType(),r=this.getPageHandler(e);this.track(e,r,t)}catch(t){console.log("Helper: error on init")}try{"function"==typeof this.createCart&&(window.crmbackCreateCart=this.createCart.bind(this))}catch(t){}}track(t,e,r){if(r!==this.time)return window._crmbackData.pageType=null,window._crmbackData.pageData=null,void console.log("Helper: restart track (page changed)");try{if(t&&(window._crmbackData.pageType=t),e){const r=e.getPageData(),a=s?.[t];if(a&&(window._crmbackData.eventType=a),r&&a&&(JSON.stringify(this.data)!==JSON.stringify(r)||!window._crmbackData.pageData)){if(window._crmbackData.pageData=r,a===o&&!r?.items?.length)return;window.crmback("event")?.setEvent(a,r),this.data=r}}}catch(t){console.log("Helper: error on extract data (track)",t)}try{this.checkCustomerData(),s?.[t]!==o&&this.checkCartData()}catch(t){console.log("Helper: error on check customer data (track)",t)}setTimeout((()=>{this.track(t,e,r)}),1e3)}async checkCustomerData(){const t=this.getCustomHandler(c);if(t){try{"function"==typeof t?.businessRules&&t.businessRules()}catch(t){console.log("Helper: error on run customer business rules (track)",t)}try{const e=localStorage.getItem("crmb-customer-checked")||0;if(Date.now()-e>=864e5&&"function"==typeof t?.extractData){const e=await t.extractData();e?.email&&window.crmback("customer").setIdentification("email",e.email),e?.phone&&window.crmback("customer").setIdentification("phone",e.phone),e?.document&&window.crmback("customer").setIdentification("document",e.document),e?.name&&window.crmback("customer").setName(e.name),e?.attributes&&window.crmback("customer").setAttributes(e.attributes),localStorage.setItem("crmb-customer-checked",Date.now())}}catch(t){console.log("Helper: error on extract customer data (track)",t)}}}async checkCartData(){const t=this.getCustomHandler(i);if(t)try{if(u(),"function"==typeof t?.extractData){const e=await t.extractData(),r=sessionStorage.getItem("crmback-cart-payload");if(!e?.items?.length)throw new Error("Cart is empty");const o=Number(localStorage.getItem("crmback-last-cart-time"));if(o&&Date.now()>=o+5e3&&e&&(localStorage.removeItem("crmback-last-cart-time"),window.crmback("event")?.setEvent("cart",e)),l(JSON.stringify(e),r))return;e&&(sessionStorage.setItem("crmback-cart-payload",JSON.stringify(e)),localStorage.setItem("crmback-last-cart-time",Date.now()))}}catch{return null}}getPageType(){throw new Error("getPageType method must be implemented.")}getPageHandler(t){try{if(!t)return;return this.handlers?.[t]||null}catch(t){console.log("Helper: error on get page handler")}}getCustomHandler(t){try{return this.handlers?.[t]||null}catch(t){console.log("Helper: error on get custom data handler")}}registerHandler(t,e){this.handlers[t]=e}watchLocation(){if(String(this.page)!==String(location.href)){this.time=(new Date).getTime(),this.page=String(location.href);const t=this.time,e=this.getPageType(),r=this.getPageHandler(e);this.track(e,r,t)}setTimeout((()=>{this.watchLocation()}),1e3)}}class f{handleData(t){if("object"==typeof t&&null!==t)if(Array.isArray(t))for(let e=0;e<t.length;e++)this.handleData(t[e]);else for(let e in t)t.hasOwnProperty(e)&&("object"==typeof t[e]&&null!==t[e]?this.handleData(t[e]):["price","total"].includes(e)?t[e]=parseFloat(t[e]):isNaN(t[e])||null===t[e]||(t[e]=t[e].toString()))}getPageData(){const t=this.extractData();return t&&this.handleData(t),t}}function g(t){return t=t.replace("-",""),/^\d{8}$/.test(t)}function w(t){return t.replace(/\D/g,"")}function y(t){try{if(!t)throw new Error("Phone not found");return(t=t.replace(/\D/g,"")).startsWith("55")&&t.length>=12&&(t=t.slice(2)),t}catch{return null}}function k(t){try{if(!t)throw new Error("Order form not found");const e=t?.clientProfileData;if(!e)throw new Error("Client profile data not found");const r=window.sessionStorage.getItem("crmback-customer-saved"),o={name:e?.firstName,email:e?.email,phone:e?.phone};if(r&&l(JSON.stringify(o),r))throw new Error("Customer already saved");o?.name&&!o?.name.includes("*")&&window.top.crmback("customer").setName(o?.name),o?.phone&&!o?.phone.includes("*")&&window.top.crmback("customer").setIdentification("phone",y(o?.phone)),o?.email&&window.top.crmback("customer").setIdentification("email",o?.email),window.sessionStorage.setItem("crmback-customer-saved",JSON.stringify({name:o?.name,email:o?.email,phone:o?.phone}))}catch{return null}}function D(t){try{if(!t)throw new Error("Order form not found");const e=t?.shippingData;if(!e)throw new Error("Shipping data not found");const r=e?.address;if(!r)throw new Error("Address not found");const o=r?.postalCode;if(!o)throw new Error("Postal code not found");if(!g(o))throw new Error("Postal code not valid");if(window.sessionStorage.getItem("crmback-customer-postalcode-saved")===w(o))throw new Error("Postal code already saved");window.crmback("customer").setAttributes({cep:w(o)}),window.sessionStorage.setItem("crmback-customer-postalcode-saved",w(o))}catch{return null}}function b(){const t=function(){try{const t=window.top?.vtexjs?.checkout?.orderForm;if(!t)throw new Error("Order form not found");if(!t?.paymentData?.payments?.length)throw new Error("No payments in order form");const e=t?.paymentData?.payments?.find((t=>t?.paymentSystem));if(!e)throw new Error("Selected payment system not found");const r=t?.paymentData?.paymentSystems.find((t=>t.id===Number(e.paymentSystem)));if(!r)throw new Error("Payment system not found");return r}catch{return null}}(),e=[];return t&&("pix"===t.name.toLowerCase()?e.push(h("pix")):t.groupName?.includes("creditCard")&&e.push(h("card"))),e}class S extends f{extractData(){try{const t=vtexjs||window.top.vtexjs;let e=null;if(t){const r=t.checkout.orderForm;r&&(k(r),D(r),r?.marketingData?.coupon&&(e=r.marketingData.coupon))}if("function"!=typeof window?.cart?.items)throw new Error("Cart not found");const r=window.cart.items();if(!r.length)throw new Error("No items in cart");let o=0;const a=r.map((t=>{let e=t.imageUrl();e.includes("/ids/")&&(e=e.match(/(.+\/ids\/[0-9])\w+/g)[0]+"/produto-imagem.jpg");const r={pid:t.id(),name:t.name(),quantity:t.quantity(),price:t.price()/100,link:location.origin+t.detailUrl(),image:location.protocol+e};return o+=r.price*r.quantity,r}));if(!a.length)throw new Error("No products in cart");const n=this.getOrderFormId(),i=d(),c={code:n||null,items:a,total:o.toFixed(2),checkout_url:this.getCheckoutUrl()};return c.additionalData=b(),e&&(c.couponCode=e),i&&i.id&&(c.id=i.id),c}catch{return null}}getOrderFormId(){let t=null;const e=window.top.vtexjs.checkout.orderFormId;if(e)return t=e,t;for(let e in dataLayer)if(dataLayer[e].orderFormId){t=dataLayer[e].orderFormId;break}return t}getCheckoutUrl(){return location.origin+location.pathname+"?orderFormId="+this.getOrderFormId()}}class x extends f{extractData(){try{const r=window.top?.vtexjs?.checkout?.orderForm;if(!r)throw new Error("Order form not found");const o={};if(t=r.clientProfileData?.phone,!!t&&("true"===localStorage.getItem("crmback-international")?(t=t.replace(/\s/g,""),!!t?.startsWith("+")):((t=t.replace(/\D/g,"")).startsWith("55")&&t.length>=12&&(t=t.slice(2)),/^\(?[0-9]{2}\)?[0-9]{4,6}-?[0-9]{4}$/.test(t)))&&(o.phone=y(r.clientProfileData?.phone)),e=r.clientProfileData?.email,e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&(o.email=r.clientProfileData?.email),r.clientProfileData?.firstName&&(o.name=r.clientProfileData?.firstName.split(" ")[0]),m(o,JSON.parse(localStorage.getItem("crmback-customer"))))throw new Error("Customer already saved");return localStorage.setItem("crmback-customer",JSON.stringify(o)),window.top.crmback("customer").setIdentification("phone",o.phone),window.top.crmback("customer").setIdentification("email",o.email),window.top.crmback("customer").setName(o.name),o}catch{return null}var t,e}}class F extends f{extractData(){}}class I extends f{extractData(){try{const t=dataLayer.findLast((t=>t?.ecommerce?.purchase?.actionField));if(!t)throw new Error("Data not found");const e=t?.ecommerce?.purchase?.actionField,r=e?.id,o=e?.revenue;if(!r||!o)throw new Error("Data not found");return function(t){if(!t||""===t)throw new Error("orderId is required");if(String(t)===localStorage.getItem("crmback-order"))throw new Error("Order already done");localStorage.setItem("crmback-order",t)}(r),{code:r,total:o,couponCode:e?.coupon||null}}catch{return null}}}class v extends f{extractData(){if(window?.skuJson?.skus)return this.extractFromSkuJson();if(window?.dataLayer){let t=this.extractFromDataLayer();if(t)return t}return this.extractFromMetaTags()}extractFromDataLayer(){const t=window?.dataLayer||[],e=this.extractFromProductDetail(t);if(!e){let e=this.extractFromViewItem(t);return e||(e=this.extractFromSelectItem(t)),e||null}return e}extractFromViewItem(t){let e=t.findLast((({ecommerce:t,event:e})=>t&&t?.items?.length&&"view_item"===e));if(!e&&(e=t.findLast((({items:t,event:e})=>t?.length&&"view_item"===e)),!e))return null;const r=e?.ecommerce?.items?.[0]||e?.items?.[0]||null;return{pid:r.item_id,name:r.item_name,price:r?.price||r?.item_price||null}}extractFromSelectItem(t){let e=t.findLast((({ecommerce:t,event:e})=>t&&t?.items?.length&&"select_item"===e));if(!e)return null;const r=e?.ecommerce?.items?.[0]||null;return{pid:r?.item_id||null,sku:r?.item_variant||null,name:r?.item_name||null,price:r?.price||null}}extractFromProductDetail(t){const e=t.findLast((({ecommerce:t,event:e})=>t&&void 0!==t.detail&&"productDetail"===e));if(!e)return;const r=e.ecommerce.detail.products[0];return{pid:r.id,name:r.name,price:r.price}}extractFromSkuJson(){const t=window?.skuJson?.skus||null;if(!t)return;const e=t.find((t=>!0===t.available));if(!e)return;if(!e?.sku||!e?.skuname||!e?.bestPrice)return;const{sku:r,skuname:o,bestPrice:a}=e;return{pid:r,name:o,price:a/100}}extractFromMetaTags(){const t=this.getMetaContent("property","product:sku"),e=this.getMetaContent("property","og:title"),r=this.getMetaContent("property","product:price:amount");if(t&&e&&r)return{pid:t,name:e,price:r}}getMetaContent(t,e){const r=document.querySelector(`meta[${t}="${e}"]`);return r?r.getAttribute("content"):null}}class P{async extractData(){const t=window?.vtexjs||window.top?.vtexjs;if(t&&t.checkout&&t.checkout.orderForm){const e=t.checkout.orderForm;if(e?.shippingData?.address?.postalCode){const t=e.shippingData.address.postalCode;if(g(t))return{attributes:{cep:w(t)}}}}return null}}class O{async extractData(){try{u();const t=this.getPayloadFromStore();if(!t?.items?.length)throw new Error("No items in cart");const e=d();return e&&e.id&&(t.id=e.id),t.additionalData=b(),t}catch{return null}}getPayloadFromStore(){const t=window.top?.vtexjs,e=window.top?.faststore_sdk_stores,r=JSON.parse(localStorage.getItem("orderform"));return t?this.getPayloadFromVtexStore():e?this.getPayloadFromVtexFaststore():r?this.getPayloadFromVtexLocalStorage():void 0}getPayloadFromVtexStore(){try{const t=window.top?.vtexjs,e=t?.checkout?.orderForm;if(e){if(k(e),D(e),!e?.items?.length)throw new Error("No items in cart");const t=e.items.map((t=>({pid:t.id,name:t.name,link:location.origin+t.detailUrl,price:t.price/100,quantity:t.quantity,image:this.formatProductImage(t.imageUrl)})));if(!t.length)throw new Error("No items in cart");const r={code:e?.orderFormId||null,items:t,total:e?.value/100||0,checkout_url:e?.orderFormId?`${location.origin}/checkout/?orderFormId=${e?.orderFormId}`:null};return e?.marketingData?.coupon&&(r.couponCode=e.marketingData.coupon),r}}catch(t){return null}}getPayloadFromVtexFaststore(){try{const t=window.top?.faststore_sdk_stores;if(0===t?.size)throw new Error("No items in cart");const e=t?.get("fs::cart")?.read();if(e){let t=0;const r=e.items.map((e=>(t+=e.price*e.quantity,{pid:e?.itemOffered?.sku||null,name:e?.itemOffered?.isVariantOf?.name||null,link:this.getFaststoreProductLink(e),price:e.price,quantity:e.quantity,image:this.formatProductImage(e?.itemOffered?.image[0].url||null)})));if(!r.length)throw new Error("No items in cart");return{code:e?.id||null,items:r,total:t,checkout_url:e?.id?`${location.origin}/checkout/?orderFormId=${e.id}#/cart`:null}}}catch(t){return null}}getPayloadFromVtexLocalStorage(){try{const t=JSON.parse(localStorage.getItem("orderform"));if(!t?.items?.length)throw new Error("No items in cart");k(t);const e=t.items.map((t=>{const e=t.imageUrls?.at1x.includes("https://")?t.imageUrls?.at1x:`${location.protocol}${t.imageUrls?.at1x}`;return{pid:t.id,name:t.name,link:location.origin+t.detailUrl,price:t.price/100,quantity:t.quantity,image:this.formatProductImage(e)}}));if(!e.length)throw new Error("No items in cart");const r={code:t?.id||null,items:e,total:t?.value/100||0,checkout_url:t?.id?`${location.origin}/checkout/?orderFormId=${t?.id}#/cart`:null};return t?.marketingData?.coupon&&(r.couponCode=t.marketingData.coupon),r}catch(t){return null}}formatProductImage(t){if(t.includes("/ids/"))return t.match(/(.+\/ids\/[0-9])\w+/g)[0]+"/produto-imagem.jpg"}getFaststoreProductLink(t){if(!t)return null;if(t?.itemOffered?.isVariantOf?.skuVariants){const e=Object.keys(t?.itemOffered?.isVariantOf?.skuVariants?.activeVariations||{})[0],r=t?.itemOffered?.isVariantOf?.skuVariants?.activeVariations[e],o=t?.itemOffered?.isVariantOf?.skuVariants?.slugsMap;if(r&&o)return location.origin+"/"+o[`${e}-${r}`]+"/p"}return t?.itemOffered?.name?location.origin+`/${e=t?.itemOffered?.name,e.normalize("NFD").toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}-${t?.itemOffered?.gtin.split("-")[0]}/p`:void 0;var e}}new class extends p{constructor(){super(),this.registerHandler(e,new v),this.registerHandler(r,new F),this.registerHandler(o,new S),this.registerHandler(n,new x),this.registerHandler(a,new I),this.registerHandler(c,new P),this.registerHandler(i,new O),this.init()}getPageType(){return"/"===location.pathname?t:location.pathname.endsWith("/p")?e:location.pathname.includes("/checkout")&&location.hash.endsWith("/cart")?o:location.pathname.includes("/checkout")&&location.hash.endsWith("/profile")||location.pathname.includes("/checkout")&&location.hash.endsWith("/shipping")||location.pathname.includes("/checkout")&&location.hash.endsWith("/payment")?n:location.pathname.includes("/checkout/orderPlaced")?a:void 0}}})();